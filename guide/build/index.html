<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>打包构建 | vue-run</title>
    <meta name="description" content="打造一个舒适的前端工作流">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
  <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.31620747.css" as="style"><link rel="preload" href="/assets/js/app.ad74b50b.js" as="script"><link rel="preload" href="/assets/js/2.2054c3ab.js" as="script"><link rel="preload" href="/assets/js/3.a4e279d6.js" as="script"><link rel="prefetch" href="/assets/js/10.2fcb329f.js"><link rel="prefetch" href="/assets/js/11.aa231dd9.js"><link rel="prefetch" href="/assets/js/12.9f1fdf0e.js"><link rel="prefetch" href="/assets/js/13.d119215d.js"><link rel="prefetch" href="/assets/js/14.de9dfb60.js"><link rel="prefetch" href="/assets/js/15.15c1321a.js"><link rel="prefetch" href="/assets/js/16.d047a64e.js"><link rel="prefetch" href="/assets/js/17.fa9b699d.js"><link rel="prefetch" href="/assets/js/18.d4110752.js"><link rel="prefetch" href="/assets/js/19.e47e31ff.js"><link rel="prefetch" href="/assets/js/20.c21ff74b.js"><link rel="prefetch" href="/assets/js/21.403ef4cb.js"><link rel="prefetch" href="/assets/js/22.afbc471c.js"><link rel="prefetch" href="/assets/js/23.8fc68b7a.js"><link rel="prefetch" href="/assets/js/24.aaa61bbc.js"><link rel="prefetch" href="/assets/js/25.1546e7a8.js"><link rel="prefetch" href="/assets/js/26.d61179ba.js"><link rel="prefetch" href="/assets/js/27.357b1395.js"><link rel="prefetch" href="/assets/js/28.cc219ae3.js"><link rel="prefetch" href="/assets/js/29.b6955861.js"><link rel="prefetch" href="/assets/js/30.043e4801.js"><link rel="prefetch" href="/assets/js/31.c1b8cf35.js"><link rel="prefetch" href="/assets/js/32.42958bd6.js"><link rel="prefetch" href="/assets/js/33.e126e05f.js"><link rel="prefetch" href="/assets/js/34.6864e25a.js"><link rel="prefetch" href="/assets/js/35.aeeec13a.js"><link rel="prefetch" href="/assets/js/36.a3946cf6.js"><link rel="prefetch" href="/assets/js/37.b4478e59.js"><link rel="prefetch" href="/assets/js/38.574146f4.js"><link rel="prefetch" href="/assets/js/39.3cd37280.js"><link rel="prefetch" href="/assets/js/4.c0861a31.js"><link rel="prefetch" href="/assets/js/40.c5a34540.js"><link rel="prefetch" href="/assets/js/41.7f323d85.js"><link rel="prefetch" href="/assets/js/42.d31181fa.js"><link rel="prefetch" href="/assets/js/43.6e0bf2e6.js"><link rel="prefetch" href="/assets/js/44.68a308ee.js"><link rel="prefetch" href="/assets/js/45.2ef9d7c8.js"><link rel="prefetch" href="/assets/js/46.5441fd11.js"><link rel="prefetch" href="/assets/js/47.fab1189a.js"><link rel="prefetch" href="/assets/js/48.ff364c5c.js"><link rel="prefetch" href="/assets/js/49.25efaf4d.js"><link rel="prefetch" href="/assets/js/5.a116802f.js"><link rel="prefetch" href="/assets/js/50.ec8ad626.js"><link rel="prefetch" href="/assets/js/51.d1f171f3.js"><link rel="prefetch" href="/assets/js/52.100e2510.js"><link rel="prefetch" href="/assets/js/53.f7e297ba.js"><link rel="prefetch" href="/assets/js/54.d0716ad6.js"><link rel="prefetch" href="/assets/js/55.6984554f.js"><link rel="prefetch" href="/assets/js/56.c9d4b98a.js"><link rel="prefetch" href="/assets/js/57.1736acb1.js"><link rel="prefetch" href="/assets/js/58.1e194851.js"><link rel="prefetch" href="/assets/js/59.cc8df9af.js"><link rel="prefetch" href="/assets/js/6.f95efe2a.js"><link rel="prefetch" href="/assets/js/60.6a846f1a.js"><link rel="prefetch" href="/assets/js/61.e0a08076.js"><link rel="prefetch" href="/assets/js/62.5b3128e3.js"><link rel="prefetch" href="/assets/js/63.d9c80c61.js"><link rel="prefetch" href="/assets/js/64.686b1cb0.js"><link rel="prefetch" href="/assets/js/65.ce207947.js"><link rel="prefetch" href="/assets/js/66.cea7a33b.js"><link rel="prefetch" href="/assets/js/67.6bf9f16e.js"><link rel="prefetch" href="/assets/js/68.c3755fba.js"><link rel="prefetch" href="/assets/js/69.1987d1f9.js"><link rel="prefetch" href="/assets/js/7.60e754f0.js"><link rel="prefetch" href="/assets/js/70.55bd8888.js"><link rel="prefetch" href="/assets/js/71.3f35de42.js"><link rel="prefetch" href="/assets/js/72.249f0def.js"><link rel="prefetch" href="/assets/js/73.e19ee3e7.js"><link rel="prefetch" href="/assets/js/8.d7e7dd67.js"><link rel="prefetch" href="/assets/js/9.b3d60b51.js">
    <link rel="stylesheet" href="/assets/css/0.styles.31620747.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">vue-run</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="/config/" class="nav-link">
  推荐配置
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Javascript书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/javascript/编写高质量JavaScript的68个有效方法.html" class="nav-link">
  编写高质量JavaScript的68个有效方法
</a></li><li class="dropdown-subitem"><a href="/books/javascript/编写可维护的JavaScript.html" class="nav-link">
  编写可维护的JavaScript
</a></li><li class="dropdown-subitem"><a href="/books/javascript/你不知道的JavaScript上卷.html" class="nav-link">
  你不知道的JavaScript(上卷)
</a></li><li class="dropdown-subitem"><a href="/books/javascript/你不知道的JavaScript中卷.html" class="nav-link">
  你不知道的JavaScript(中卷)
</a></li><li class="dropdown-subitem"><a href="/books/javascript/ES6标准入门.html" class="nav-link">
  ES6标准入门
</a></li><li class="dropdown-subitem"><a href="/books/javascript/深入理解ES6.html" class="nav-link">
  深入理解ES6
</a></li><li class="dropdown-subitem"><a href="/books/javascript/深入理解TypeScript.html" class="nav-link">
  深入理解TypeScript
</a></li><li class="dropdown-subitem"><a href="/books/javascript/深入浅出Vue.js.html" class="nav-link">
  深入浅出Vue.js
</a></li><li class="dropdown-subitem"><a href="/books/javascript/了不起的JavaScript工程师.html" class="nav-link">
  了不起的JavaScript工程师
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript高级程序设计.html" class="nav-link">
  JavaScript高级程序设计
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript面向对象编程指南.html" class="nav-link">
  JavaScript面向对象编程指南
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript面向对象精要.html" class="nav-link">
  JavaScript面向对象精要
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript函数式编程指南.html" class="nav-link">
  JavaScript函数式编程指南
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript忍者秘籍.html" class="nav-link">
  JavaScript忍者秘籍
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript编程精解.html" class="nav-link">
  JavaScript编程精解
</a></li><li class="dropdown-subitem"><a href="/books/javascript/Javascript语言精髓与编程实践.html" class="nav-link">
  JavaScript语言精髓与编程实践
</a></li><li class="dropdown-subitem"><a href="/books/javascript/Javascript设计模式与开发实战.html" class="nav-link">
  JavaScript设计模式与开发实战
</a></li><li class="dropdown-subitem"><a href="/books/javascript/Javascript框架设计.html" class="nav-link">
  JavaScript框架设计
</a></li></ul></li><li class="dropdown-item"><h4>
          Node书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/node/Node.js实战.html" class="nav-link">
  Node.js实战
</a></li><li class="dropdown-subitem"><a href="/books/node/Node.js开发实战.html" class="nav-link">
  Node.js开发实战
</a></li><li class="dropdown-subitem"><a href="/books/node/Node.js设计模式.html" class="nav-link">
  Node.js设计模式
</a></li></ul></li><li class="dropdown-item"><h4>
          算法书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/algorithmic/学习JavaScript数据结构与算法.html" class="nav-link">
  学习JavaScript数据结构与算法
</a></li></ul></li><li class="dropdown-item"><h4>
          css书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/css/css揭秘.html" class="nav-link">
  CSS揭秘
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面经" class="dropdown-title"><span class="title">面经</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/JavaScript.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/interview/CSS.html" class="nav-link">
  CSS
</a></li><li class="dropdown-subitem"><a href="/interview/HTTP.html" class="nav-link">
  HTTP
</a></li></ul></li><li class="dropdown-item"><h4>
          进阶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/设计模式.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-subitem"><a href="/interview/Node.html" class="nav-link">
  Node
</a></li><li class="dropdown-subitem"><a href="/interview/算法.html" class="nav-link">
  算法
</a></li><li class="dropdown-subitem"><a href="/interview/兼容性.html" class="nav-link">
  兼容性
</a></li><li class="dropdown-subitem"><a href="/interview/缓存.html" class="nav-link">
  缓存
</a></li><li class="dropdown-subitem"><a href="/interview/性能优化.html" class="nav-link">
  性能优化
</a></li></ul></li><li class="dropdown-item"><h4>
          RunTime
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/浏览器.html" class="nav-link">
  浏览器
</a></li><li class="dropdown-subitem"><a href="/interview/Webpack.html" class="nav-link">
  Webpack
</a></li></ul></li><li class="dropdown-item"><h4>
          选型
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/Vue.html" class="nav-link">
  Vue
</a></li><li class="dropdown-subitem"><a href="/interview/React.html" class="nav-link">
  React
</a></li></ul></li><li class="dropdown-item"><h4>
          能力周边
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/Git操作.html" class="nav-link">
  Git操作
</a></li><li class="dropdown-subitem"><a href="/interview/前端监控.html" class="nav-link">
  前端监控
</a></li><li class="dropdown-subitem"><a href="/interview/安全防范.html" class="nav-link">
  安全防范
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/practice/" class="nav-link">
  最佳实践
</a></div><div class="nav-item"><a href="/summary/" class="nav-link">
  只言片语
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="/config/" class="nav-link">
  推荐配置
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Javascript书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/javascript/编写高质量JavaScript的68个有效方法.html" class="nav-link">
  编写高质量JavaScript的68个有效方法
</a></li><li class="dropdown-subitem"><a href="/books/javascript/编写可维护的JavaScript.html" class="nav-link">
  编写可维护的JavaScript
</a></li><li class="dropdown-subitem"><a href="/books/javascript/你不知道的JavaScript上卷.html" class="nav-link">
  你不知道的JavaScript(上卷)
</a></li><li class="dropdown-subitem"><a href="/books/javascript/你不知道的JavaScript中卷.html" class="nav-link">
  你不知道的JavaScript(中卷)
</a></li><li class="dropdown-subitem"><a href="/books/javascript/ES6标准入门.html" class="nav-link">
  ES6标准入门
</a></li><li class="dropdown-subitem"><a href="/books/javascript/深入理解ES6.html" class="nav-link">
  深入理解ES6
</a></li><li class="dropdown-subitem"><a href="/books/javascript/深入理解TypeScript.html" class="nav-link">
  深入理解TypeScript
</a></li><li class="dropdown-subitem"><a href="/books/javascript/深入浅出Vue.js.html" class="nav-link">
  深入浅出Vue.js
</a></li><li class="dropdown-subitem"><a href="/books/javascript/了不起的JavaScript工程师.html" class="nav-link">
  了不起的JavaScript工程师
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript高级程序设计.html" class="nav-link">
  JavaScript高级程序设计
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript面向对象编程指南.html" class="nav-link">
  JavaScript面向对象编程指南
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript面向对象精要.html" class="nav-link">
  JavaScript面向对象精要
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript函数式编程指南.html" class="nav-link">
  JavaScript函数式编程指南
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript忍者秘籍.html" class="nav-link">
  JavaScript忍者秘籍
</a></li><li class="dropdown-subitem"><a href="/books/javascript/JavaScript编程精解.html" class="nav-link">
  JavaScript编程精解
</a></li><li class="dropdown-subitem"><a href="/books/javascript/Javascript语言精髓与编程实践.html" class="nav-link">
  JavaScript语言精髓与编程实践
</a></li><li class="dropdown-subitem"><a href="/books/javascript/Javascript设计模式与开发实战.html" class="nav-link">
  JavaScript设计模式与开发实战
</a></li><li class="dropdown-subitem"><a href="/books/javascript/Javascript框架设计.html" class="nav-link">
  JavaScript框架设计
</a></li></ul></li><li class="dropdown-item"><h4>
          Node书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/node/Node.js实战.html" class="nav-link">
  Node.js实战
</a></li><li class="dropdown-subitem"><a href="/books/node/Node.js开发实战.html" class="nav-link">
  Node.js开发实战
</a></li><li class="dropdown-subitem"><a href="/books/node/Node.js设计模式.html" class="nav-link">
  Node.js设计模式
</a></li></ul></li><li class="dropdown-item"><h4>
          算法书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/algorithmic/学习JavaScript数据结构与算法.html" class="nav-link">
  学习JavaScript数据结构与算法
</a></li></ul></li><li class="dropdown-item"><h4>
          css书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/css/css揭秘.html" class="nav-link">
  CSS揭秘
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面经" class="dropdown-title"><span class="title">面经</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/JavaScript.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/interview/CSS.html" class="nav-link">
  CSS
</a></li><li class="dropdown-subitem"><a href="/interview/HTTP.html" class="nav-link">
  HTTP
</a></li></ul></li><li class="dropdown-item"><h4>
          进阶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/设计模式.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-subitem"><a href="/interview/Node.html" class="nav-link">
  Node
</a></li><li class="dropdown-subitem"><a href="/interview/算法.html" class="nav-link">
  算法
</a></li><li class="dropdown-subitem"><a href="/interview/兼容性.html" class="nav-link">
  兼容性
</a></li><li class="dropdown-subitem"><a href="/interview/缓存.html" class="nav-link">
  缓存
</a></li><li class="dropdown-subitem"><a href="/interview/性能优化.html" class="nav-link">
  性能优化
</a></li></ul></li><li class="dropdown-item"><h4>
          RunTime
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/浏览器.html" class="nav-link">
  浏览器
</a></li><li class="dropdown-subitem"><a href="/interview/Webpack.html" class="nav-link">
  Webpack
</a></li></ul></li><li class="dropdown-item"><h4>
          选型
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/Vue.html" class="nav-link">
  Vue
</a></li><li class="dropdown-subitem"><a href="/interview/React.html" class="nav-link">
  React
</a></li></ul></li><li class="dropdown-item"><h4>
          能力周边
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/interview/Git操作.html" class="nav-link">
  Git操作
</a></li><li class="dropdown-subitem"><a href="/interview/前端监控.html" class="nav-link">
  前端监控
</a></li><li class="dropdown-subitem"><a href="/interview/安全防范.html" class="nav-link">
  安全防范
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/practice/" class="nav-link">
  最佳实践
</a></div><div class="nav-item"><a href="/summary/" class="nav-link">
  只言片语
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>目录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/目录.html" class="sidebar-link">目录介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>请求</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/request/" class="sidebar-link">接口请求</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>构建</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/build/" class="active sidebar-link">打包构建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/build/#天下武功，唯快不破" class="sidebar-link">天下武功，唯快不破</a></li><li class="sidebar-sub-header"><a href="/guide/build/#新特性" class="sidebar-link">新特性</a></li><li class="sidebar-sub-header"><a href="/guide/build/#准备" class="sidebar-link">准备</a></li><li class="sidebar-sub-header"><a href="/guide/build/#升级避坑指南" class="sidebar-link">升级避坑指南</a></li><li class="sidebar-sub-header"><a href="/guide/build/#持续加速" class="sidebar-link">持续加速</a></li><li class="sidebar-sub-header"><a href="/guide/build/#编译结果分析" class="sidebar-link">编译结果分析</a></li><li class="sidebar-sub-header"><a href="/guide/build/#面向-tree-shaking，约束编码" class="sidebar-link">面向 tree-shaking，约束编码</a></li><li class="sidebar-sub-header"><a href="/guide/build/#结尾" class="sidebar-link">结尾</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/store/" class="sidebar-link">数据容器</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>调优</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/optimize/" class="sidebar-link">调优</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="打包构建"><a href="#打包构建" class="header-anchor">#</a> 打包构建</h1> <p><img src="/assets/img/webpack.516e29cb.png" alt="Webpack"></p> <p></p><div class="table-of-contents"><ul><li><a href="#天下武功，唯快不破">天下武功，唯快不破</a></li><li><a href="#新特性">新特性</a></li><li><a href="#准备">准备</a></li><li><a href="#升级避坑指南">升级避坑指南</a></li><li><a href="#持续加速">持续加速</a></li><li><a href="#编译结果分析">编译结果分析</a></li><li><a href="#面向-tree-shaking，约束编码">面向 tree-shaking，约束编码</a></li><li><a href="#结尾">结尾</a></li></ul></div>
对于现在的前端项目而言，编译发布几乎是必需操作，有的编译只需要几秒钟，快如闪电，有的却需要 10 分钟，甚至更多，慢如蜗牛。特别是线上热修复时，分秒必争，响应速度直接影响了用户体验，用户不会有耐心等那么长时间，让你慢慢编译；如果涉及到支付操作，产品损失更是以秒计，每提前哪怕一秒钟发布，在腾讯海量用户面前，都能挽回不小的损失。不仅如此，编译效率的提升，带来的最直观收益就是，开发效率与开发体验双重提升。<p></p> <p>那么，到底是什么拖慢了 webpack 打包效率，我们又能做哪些提升呢？</p> <p>webpack 是目前非常受欢迎的打包工具，截止几天前，webpack4 已更新至 4.26.1 版本，10 个月的时间，小版本更新达几十次之多，可见社区之繁荣。</p> <p>webpack4 发布时，官方也曾表示，其编译速度提升了<strong>60% ~ 98%</strong>。</p> <h2 id="天下武功，唯快不破"><a href="#天下武功，唯快不破" class="header-anchor">#</a> 天下武功，唯快不破</h2> <p>由于本地项目升级到 webpack4 有几个月了，为了获得测试数据，手动将 webpack 降级为 3.12.0 版本，其它配置基本不做改动。</p> <p>测试时，Mac 仅运行常用的 IM、邮箱、终端、浏览器等，为了尽可能避免插件对数据的影响，我关闭了一些优化插件，只保留常用的 loader、js 压缩插件。</p> <p>以下是分别在 webpack@3.12.0 及 webpack@4.26.1 两种场景下各测 5 次的运行截图。</p> <p><img src="/assets/img/webpack1.e6192958.png" alt="webpack3~4x 编译速度对比"></p> <p>数据分析如下（单位 ms）：</p> <table><thead><tr><th></th> <th style="text-align:center;"><strong>第 1 次</strong></th> <th style="text-align:center;"><strong>第 2 次</strong></th> <th style="text-align:center;"><strong>第 3 次</strong></th> <th style="text-align:center;"><strong>第 4 次</strong></th> <th style="text-align:center;"><strong>第 5 次</strong></th> <th style="text-align:center;"><strong>平均</strong></th> <th style="text-align:center;"><strong>速度提升</strong></th></tr></thead> <tbody><tr><td>webpack3</td> <td style="text-align:center;">58293</td> <td style="text-align:center;">60971</td> <td style="text-align:center;">57263</td> <td style="text-align:center;">58993</td> <td style="text-align:center;">60459</td> <td style="text-align:center;">59195.8</td> <td style="text-align:center;">-</td></tr> <tr><td>webpack4</td> <td style="text-align:center;">42346</td> <td style="text-align:center;">40386</td> <td style="text-align:center;">40138</td> <td style="text-align:center;">40330</td> <td style="text-align:center;">40323</td> <td style="text-align:center;">40704.6</td> <td style="text-align:center;">45%</td></tr></tbody></table> <p>纯粹的版本升级，编译速度提升为 <code>45%</code>，这里我选取的是成熟的线上运行项目，构建速度的提升只有建立在成熟项目上才有意义，demo 项目由于编译文件基数小，难以体现出构建环境的复杂性，测试时也可能存在较大误差。同时与官方数据的差距，主要是因为基于的项目及配置不同。</p> <p>无论如何，近 50% 的编译速度提升，都值得你尝试升级 webpack4！当然，优化才刚刚开始，请继续往下读。</p> <h2 id="新特性"><a href="#新特性" class="header-anchor">#</a> 新特性</h2> <p>为了更流畅的升级 webpack4，我们先要了解它。</p> <p>webpack4 在大幅度提升编译效率同时，引入了多种新特性：</p> <ol><li><p>受 Parcel 启发，支持 0 配置启动项目，不再强制需要 webpack.config.js 配置文件，默认入口 <code>./src/</code> 目录，默认 entry <code>./src/index.js</code> ，默认输出 <code>./dist</code> 目录，默认输出文件 <code>./dist/main.js</code>。</p></li> <li><p>开箱即用 WebAssembly，webpack4 提供了 wasm 的支持，现在可以引入和导出任何一个 Webassembly 的模块，也可以写一个 loader 来引入 C++、C 和 Rust。（注：WebAssembly 模块只能在异步 chunks 中使用）</p></li> <li><p>提供 mode 属性，设置为 <code>development</code> 将获得最好的开发体验，设置为 <code>production</code> 将专注项目编译部署，比如说开启 Scope hoisting 和 Tree-shaking 功能。</p></li> <li><p>全新的插件系统，提供了针对插件和钩子的新 API，变化如下：</p> <ul><li>所有的 hook 由 hooks 对象统一管理，它将所有的 hook 作为可扩展的类属性</li> <li>添加插件时，你需要提供一个名字</li> <li>开发插件时，你可以选择插件的类型（sync/callback/promise 之一）</li> <li>通过 this.hooks = { myHook: new SyncHook(…) } 来注册 hook</li></ul> <p>更多插件的工作原理，可以参考：<a href="https://medium.com/webpack/the-new-plugin-system-week-22-23-c24e3b22e95" target="_blank" rel="noopener noreferrer">新插件系统如何工作<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></li></ol> <h2 id="准备"><a href="#准备" class="header-anchor">#</a> 准备</h2> <p>首先，webpack-dev-server 插件需要升级至最新，同时，由于 webpack-cli 承担了 webpack4 命令行相关的功能，因此 webpack-cli 也是必需的。</p> <p>与以往不同的是，mode 属性必须指定，否则按照 <code>约定优于配置</code> 原则，将默认按照 <code>production</code> 生产环境编译，如下是警告原文。</p> <blockquote><p>WARNING in configuration
The ‘mode’ option has not been set, webpack will fallback to ‘production’ for this value. Set ‘mode’ option to ‘development’ or ‘production’ to enable defaults for each environment.
You can also set it to ‘none’ to disable any default behavior. Learn more: <a href="https://webpack.js.org/concepts/mode/" target="_blank" rel="noopener noreferrer">https://webpack.js.org/concepts/mode/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>有两种方式可以加入 mode 配置。</p> <ul><li><p>在 package.json script 中指定–mode：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack-dev-server --mode development --inline --progress --config build/webpack.dev.config.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --mode production --progress --config build/webpack.prod.config.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>在配置文件中加入 mode 属性</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'production'</span> <span class="token comment">// 或 development</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <p>升级至 webpack4 后，一些默认插件由 optimization 配置替代了，如下：</p> <ul><li>CommonsChunkPlugin 废弃，由 optimization.splitChunks 和 optimization.runtimeChunk 替代，前者拆分代码，后者提取 runtime 代码。原来的 CommonsChunkPlugin 产出模块时，会包含重复的代码，并且无法优化异步模块，minchunks 的配置也较复杂，splitChunks 解决了这个问题；另外，将 optimization.runtimeChunk 设置为 true（或{name: “manifest”}），便能将入口模块中的 runtime 部分提取出来。</li> <li>NoEmitOnErrorsPlugin 废弃，由 optimization.noEmitOnErrors 替代，生产环境默认开启。</li> <li>NamedModulesPlugin 废弃，由 optimization.namedModules 替代，生产环境默认开启。</li> <li>ModuleConcatenationPlugin 废弃，由 optimization.concatenateModules 替代，生产环境默认开启。</li> <li>optimize.UglifyJsPlugin 废弃，由 optimization.minimize 替代，生产环境默认开启。</li></ul> <p>不仅如此，optimization 还提供了如下默认配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    minimize<span class="token operator">:</span> env <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 开发环境不压缩</span>
    splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
        chunks<span class="token operator">:</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 共有三个值可选：initial(初始模块)、async(按需加载模块)和all(全部模块)</span>
        minSize<span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment">// 模块超过30k自动被抽离成公共模块</span>
        minChunks<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 模块被引用&gt;=1次，便分割</span>
        maxAsyncRequests<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token comment">// 异步加载chunk的并发请求数量&lt;=5</span>
        maxInitialRequests<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 一个入口并发加载的chunk数量&lt;=3</span>
        name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 默认由模块名+hash命名，名称相同时多个模块将合并为1个，可以设置为function</span>
        automaticNameDelimiter<span class="token operator">:</span> <span class="token string">'~'</span><span class="token punctuation">,</span> <span class="token comment">// 命名分隔符</span>
        cacheGroups<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 缓存组，会继承和覆盖splitChunks的配置</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 模块缓存规则，设置为false，默认缓存组将禁用</span>
                minChunks<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 模块被引用&gt;=2次，拆分至vendors公共模块</span>
                priority<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 优先级</span>
                reuseExistingChunk<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 默认使用已有的模块</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            vendors<span class="token operator">:</span> <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex">/[\\/]node_modules[\\/]/</span><span class="token punctuation">,</span> <span class="token comment">// 表示默认拆分node_modules中的模块</span>
                priority<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>splitChunks 是拆包优化的重点，如果你的项目中包含 element-ui 等第三方组件（组件较大），建议单独拆包，如下所示。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    cacheGroups<span class="token operator">:</span> <span class="token punctuation">{</span>
        elementUI<span class="token operator">:</span> <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">&quot;chunk-elementUI&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 单独将 elementUI 拆包</span>
            priority<span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token comment">// 权重需大于其它缓存组</span>
            test<span class="token operator">:</span> <span class="token regex">/[\/]node_modules[\/]element-ui[\/]/</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>其更多用法，请参考以上注释或官方文档 <a href="https://webpack.js.org/plugins/split-chunks-plugin/" target="_blank" rel="noopener noreferrer">SplitChunksPlugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="升级避坑指南"><a href="#升级避坑指南" class="header-anchor">#</a> 升级避坑指南</h2> <blockquote><p>webpack4 不再支持 Node 4，由于使用了 JavaScript 新语法，Webpack 的创始人之一，Tobias，建议用户使用 Node 版本 &gt;= 8.94，以便使用最优性能。</p></blockquote> <p>正式升级后，你可能会遇到各种各样的错误，其中，下面一些问题较为常见。</p> <p>vue-loader v15 需要在 webpack 中添加 VueLoaderPlugin 插件，参考如下。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> VueLoaderPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-loader'</span><span class="token punctuation">)</span> <span class="token comment">// const VueLoaderPlugin = require(&quot;vue-loader/lib/plugin&quot;); // 两者等同</span>

<span class="token comment">//...</span>
plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>升级到 webpack4 后，mini-css-extract-plugin 替代 extract-text-webpack-plugin 成为 css 打包首选，相比之前，它有如下优势：</p> <ol><li>异步加载</li> <li>不重复编译，性能更好</li> <li>更容易使用</li></ol> <p>缺陷，不支持 css 热更新。因此需在开发环境引入 css-hot-loader，以便支持 css 热更新，如下所示：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token regex">/\.scss$/</span><span class="token punctuation">,</span>
    use<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span><span class="token punctuation">(</span>isDev <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">&quot;css-hot-loader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
        postcss<span class="token punctuation">,</span>
        <span class="token string">&quot;sass-loader&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>发布到生产环境之前，css 是需要优化压缩的，使用 optimize-css-assets-webpack-plugin 插件即可，如下。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> OptimizeCssAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'optimize-css-assets-webpack-plugin'</span><span class="token punctuation">)</span>

<span class="token comment">//...</span>
plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">OptimizeCssAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    cssProcessor<span class="token operator">:</span> cssnano<span class="token punctuation">,</span>
    cssProcessorOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      discardComments<span class="token operator">:</span> <span class="token punctuation">{</span>
        removeAll<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="持续加速"><a href="#持续加速" class="header-anchor">#</a> 持续加速</h2> <p>文章开始，我曾提到，优化才刚刚开始。是的，随着项目越来越复杂，webpack 也随之变慢，一定有办法可以进一步压榨性能。</p> <p>经过很长一段时间的多个项目运行以及测试，以下几点经验<strong>非常有效</strong>。</p> <ol><li><p>缩小编译范围，减少不必要的编译工作，即 modules、mainFields、noParse、includes、exclude、alias 全部用起来。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">dir</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>
resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    modules<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 指定以下目录寻找第三方模块，避免webpack往父级目录递归搜索</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>common<span class="token punctuation">.</span>layoutPath<span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    mainFields<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 只采用main字段作为入口文件描述字段，减少搜索步骤</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
        vue$<span class="token operator">:</span> <span class="token string">&quot;vue/dist/vue.common&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;@&quot;</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 缓存src目录为@符号，避免重复寻址</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
module<span class="token operator">:</span> <span class="token punctuation">{</span>
    noParse<span class="token operator">:</span> <span class="token regex">/jquery|lodash/</span><span class="token punctuation">,</span> <span class="token comment">// 忽略未采用模块化的文件，因此jquery或lodash将不会被下面的loaders解析</span>
    <span class="token comment">// noParse: function(content) {</span>
    <span class="token comment">//     return /jquery|lodash/.test(content)</span>
    <span class="token comment">// },</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            test<span class="token operator">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
            include<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 表示只解析以下目录，减少loader处理范围</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>common<span class="token punctuation">.</span>layoutPath<span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token function-variable function">exclude</span><span class="token operator">:</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token regex">/test/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 排除test目录文件</span>
            loader<span class="token operator">:</span> <span class="token string">&quot;happypack/loader?id=happy-babel&quot;</span> <span class="token comment">// 后面会介绍</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li> <li><p>想要进一步提升编译速度，就要知道瓶颈在哪？通过测试，发现有两个阶段较慢：① babel 等 loaders 解析阶段；② js 压缩阶段。loader 解析稍后会讨论，而 js 压缩是发布编译的最后阶段，通常 webpack 需要卡好一会，这是因为压缩 JS 需要先将代码解析成 AST 语法树，然后需要根据复杂的规则去分析和处理 AST，最后将 AST 还原成 JS，这个过程涉及到大量计算，因此比较耗时。如下图，编译就看似卡住。</p> <p><img src="/assets/img/webpack2.e93e05db.png" alt="ParallelUglify"></p> <p>实际上，搭载 webpack-parallel-uglify-plugin 插件，这个过程可以倍速提升。我们都知道 node 是单线程的，但 node 能够 fork 子进程，基于此，webpack-parallel-uglify-plugin 能够把任务分解给多个子进程去并发的执行，子进程处理完后再把结果发送给主进程，从而实现并发编译，进而大幅提升 js 压缩速度，如下是配置。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ParallelUglifyPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-parallel-uglify-plugin'</span><span class="token punctuation">)</span>

<span class="token comment">// ...</span>
optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
  minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">ParallelUglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 多进程压缩</span>
      cacheDir<span class="token operator">:</span> <span class="token string">'.cache/'</span><span class="token punctuation">,</span>
      uglifyJS<span class="token operator">:</span> <span class="token punctuation">{</span>
        output<span class="token operator">:</span> <span class="token punctuation">{</span>
          comments<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          beautify<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        compress<span class="token operator">:</span> <span class="token punctuation">{</span>
          warnings<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          drop_console<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          collapse_vars<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          reduce_vars<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>当然，我分别测试了五组数据，如下是截图：
<img src="/assets/img/webpack3.81b82995.png" alt="ParallelUglifyPlugin插件启用后编译速度分析"></p></li></ol> <p>数据分析如下（单位 ms）：</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">第 1 次</th> <th style="text-align:center;">第 2 次</th> <th style="text-align:center;">第 3 次</th> <th style="text-align:center;">第 4 次</th> <th style="text-align:center;">第 5 次</th> <th style="text-align:center;">平均</th> <th style="text-align:center;">速度提升</th></tr></thead> <tbody><tr><td style="text-align:center;">webpack3</td> <td style="text-align:center;">58293</td> <td style="text-align:center;">60971</td> <td style="text-align:center;">57263</td> <td style="text-align:center;">58993</td> <td style="text-align:center;">60459</td> <td style="text-align:center;">59195.8</td> <td style="text-align:center;">-</td></tr> <tr><td style="text-align:center;">webpack3 搭载 ParallelUglifyPlugin 插件</td> <td style="text-align:center;">44380</td> <td style="text-align:center;">39969</td> <td style="text-align:center;">39694</td> <td style="text-align:center;">39344</td> <td style="text-align:center;">39295</td> <td style="text-align:center;">40536.4</td> <td style="text-align:center;">46%</td></tr> <tr><td style="text-align:center;">webpack4</td> <td style="text-align:center;">42346</td> <td style="text-align:center;">40386</td> <td style="text-align:center;">40138</td> <td style="text-align:center;">40330</td> <td style="text-align:center;">40323</td> <td style="text-align:center;">40704.6</td> <td style="text-align:center;">-</td></tr> <tr><td style="text-align:center;">webpack4 搭载 ParallelUglifyPlugin 插件</td> <td style="text-align:center;">31134</td> <td style="text-align:center;">29554</td> <td style="text-align:center;">31883</td> <td style="text-align:center;">29198</td> <td style="text-align:center;">29072</td> <td style="text-align:center;">30168.2</td> <td style="text-align:center;">35%</td></tr></tbody></table> <p>搭载 webpack-parallel-uglify-plugin 插件后，webpack3 的构建速度能够提升 46%；即使升级到 webpack4 后，构建速度依然能够进一步提升 35%。</p> <ol><li><p>现在我们来看看，loader 解析速度如何提升。同 webpack-parallel-uglify-plugin 插件一样，HappyPack 也能实现并发编译，从而可以大幅提升 loader 的解析速度， 如下是部分配置。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> HappyPack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'happypack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> happyThreadPool <span class="token operator">=</span> HappyPack<span class="token punctuation">.</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span> size<span class="token operator">:</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">createHappyPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> loaders</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token keyword">new</span> <span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span> id<span class="token punctuation">,</span>
    loaders<span class="token operator">:</span> loaders<span class="token punctuation">,</span>
    threadPool<span class="token operator">:</span> happyThreadPool<span class="token punctuation">,</span>
    verbose<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HAPPY_VERBOSE</span> <span class="token operator">===</span> <span class="token string">'1'</span> <span class="token comment">// make happy more verbose with HAPPY_VERBOSE=1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>那么，对于前面 <code>loader: &quot;happypack/loader?id=happy-babel&quot;</code> 这句，便需要在 plugins 中创建一个 <code>happy-babel</code> 的插件实例。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token function">createHappyPlugin</span><span class="token punctuation">(</span><span class="token string">'happy-babel'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        babelrc<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        cacheDirectory<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 启用缓存</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如下，happyPack 开启了 3 个进程（默认为 CPU 数-1），运行过程感受下。</p> <p><img src="/assets/img/webpack4.585ee913.gif" alt="happyPack"></p></li></ol> <p>另外，像 vue-loader、css-loader 都支持 happyPack 加速，如下所示。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token function">createHappyPlugin</span><span class="token punctuation">(</span><span class="token string">'happy-css'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'vue-style-loader'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    loaders<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'vue-loader'</span><span class="token punctuation">,</span>
        query<span class="token operator">:</span> <span class="token punctuation">{</span>
          loaders<span class="token operator">:</span> <span class="token punctuation">{</span>
            scss<span class="token operator">:</span> <span class="token string">'vue-style-loader!css-loader!postcss-loader!sass-loader?indentedSyntax'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>基于 webpack4，搭载 webpack-parallel-uglify-plugin 和 happyPack 插件，测试截图如下：</p> <p><img src="/assets/img/webpack5.e5a92a3e.png" alt="搭载两款插件后编译速度分析"></p> <p>数据分析如下（单位 ms）：</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">第 1 次</th> <th style="text-align:center;">第 2 次</th> <th style="text-align:center;">第 3 次</th> <th style="text-align:center;">第 4 次</th> <th style="text-align:center;">第 5 次</th> <th style="text-align:center;">平均</th> <th style="text-align:center;">速度提升</th></tr></thead> <tbody><tr><td style="text-align:center;">仅搭载 ParallelUglifyPlugin</td> <td style="text-align:center;">31134</td> <td style="text-align:center;">29554</td> <td style="text-align:center;">31883</td> <td style="text-align:center;">29198</td> <td style="text-align:center;">29072</td> <td style="text-align:center;">30168.2</td> <td style="text-align:center;">35%</td></tr> <tr><td style="text-align:center;">搭载 ParallelUglifyPlugin 和 happyPack</td> <td style="text-align:center;">26036</td> <td style="text-align:center;">25884</td> <td style="text-align:center;">25645</td> <td style="text-align:center;">25627</td> <td style="text-align:center;">25794</td> <td style="text-align:center;">25797.2</td> <td style="text-align:center;">17%</td></tr></tbody></table> <p>可见，在搭载 webpack-parallel-uglify-plugin 插件的基础上，happyPack 插件依然能够提升 17% 的编译速度，实际上由于 sass 等 loaders 不支持 happyPack，happyPack 的性能依然有提升空间。更多介绍不妨参考 <a href="http://taobaofed.org/blog/2016/12/08/happypack-source-code-analysis/" target="_blank" rel="noopener noreferrer">happypack 原理解析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <ol><li><p>我们都知道，webpack 打包时，有一些框架代码是基本不变的，比如说 babel-polyfill、vue、vue-router、vuex、axios、element-ui、fastclick 等，这些模块也有不小的 size，每次编译都要加载一遍，比较费时费力。使用 DLLPlugin 和 DLLReferencePlugin 插件，便可以将这些模块提前打包。</p> <p>为了完成 dll 过程，我们需要准备一份新的 webpack 配置，即 webpack.dll.config.js。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> CleanWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'clean-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> dllPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/assets/dll'</span><span class="token punctuation">)</span> <span class="token comment">// dll文件存放的目录</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 把 vue 相关模块的放到一个单独的动态链接库</span>
    vue<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-polyfill'</span><span class="token punctuation">,</span> <span class="token string">'fastclick'</span><span class="token punctuation">,</span> <span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token string">'vue-router'</span><span class="token punctuation">,</span> <span class="token string">'vuex'</span><span class="token punctuation">,</span> <span class="token string">'axios'</span><span class="token punctuation">,</span> <span class="token string">'element-ui'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">'[name]-[hash].dll.js'</span><span class="token punctuation">,</span> <span class="token comment">// 生成vue.dll.js</span>
    path<span class="token operator">:</span> dllPath<span class="token punctuation">,</span>
    library<span class="token operator">:</span> <span class="token string">'_dll_[name]'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'*.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 清除之前的dll文件</span>
      root<span class="token operator">:</span> dllPath
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'_dll_[name]'</span><span class="token punctuation">,</span>
      <span class="token comment">// manifest.json 描述动态链接库包含了哪些内容</span>
      path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token string">'[name].dll.manifest.json'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>接着， 需要在 package.json 中新增 dll 命令。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;dll&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --mode production --config build/webpack.dll.config.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>运行 <code>npm run dll</code> 后，会生成 <code>./src/assets/dll/vue.dll-[hash].js</code> 公共 js 和 <code>./build/vue.dll.manifest.json</code> 资源说明文件，至此 dll 准备工作完成，接下来在 wepack 中引用即可。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>externals<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'vue'</span><span class="token operator">:</span> <span class="token string">'Vue'</span><span class="token punctuation">,</span>
    <span class="token string">'vue-router'</span><span class="token operator">:</span> <span class="token string">'VueRouter'</span><span class="token punctuation">,</span>
    <span class="token string">'vuex'</span><span class="token operator">:</span> <span class="token string">'vuex'</span><span class="token punctuation">,</span>
    <span class="token string">'elemenct-ui'</span><span class="token operator">:</span> <span class="token string">'ELEMENT'</span><span class="token punctuation">,</span>
    <span class="token string">'axios'</span><span class="token operator">:</span> <span class="token string">'axios'</span><span class="token punctuation">,</span>
    <span class="token string">'fastclick'</span><span class="token operator">:</span> <span class="token string">'FastClick'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>common<span class="token punctuation">.</span>needDll <span class="token operator">?</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            manifest<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./vue.dll.manifest.json&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>dll 公共 js 轻易不会变化，假如在将来真的发生了更新，那么新的 dll 文件名便需要加上新的 hash，从而避免浏览器缓存老的文件，造成执行出错。由于 hash 的不确定性，我们在 html 入口文件中没办法指定一个固定链接的 script 脚本，刚好，add-asset-html-webpack-plugin 插件可以帮我们自动引入 dll 文件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">autoAddDllRes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> AddAssetHtmlPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'add-asset-html-webpack-plugin'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AddAssetHtmlPlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// 往html中注入dll js</span>
      publicPath<span class="token operator">:</span> config<span class="token punctuation">.</span>common<span class="token punctuation">.</span>publicPath <span class="token operator">+</span> <span class="token string">'dll/'</span><span class="token punctuation">,</span> <span class="token comment">// 注入到html中的路径</span>
      outputPath<span class="token operator">:</span> <span class="token string">'dll'</span><span class="token punctuation">,</span> <span class="token comment">// 最终输出的目录</span>
      filepath<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/assets/dll/*.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      includeSourcemap<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      typeOfAsset<span class="token operator">:</span> <span class="token string">'js'</span> <span class="token comment">// options js、css; default js</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token operator">/</span><span class="token operator">/</span> <span class="token operator">...</span>
plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>common<span class="token punctuation">.</span>needDll <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token function">autoAddDllRes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>搭载 dll 插件后，webpack4 编译速度进一步提升，如下截图：</p> <p><img src="/assets/img/webpack6.84877afb.png" alt="搭载三款插件后编译速度分析"></p> <p>数据分析如下（单位 ms）：</p></li></ol> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">第 1 次</th> <th style="text-align:center;">第 2 次</th> <th style="text-align:center;">第 3 次</th> <th style="text-align:center;">第 4 次</th> <th style="text-align:center;">第 5 次</th> <th style="text-align:center;">平均</th> <th style="text-align:center;">速度提升</th></tr></thead> <tbody><tr><td style="text-align:center;">搭载 ParallelUglifyPlugin 和 happyPack</td> <td style="text-align:center;">26036</td> <td style="text-align:center;">25884</td> <td style="text-align:center;">25645</td> <td style="text-align:center;">25627</td> <td style="text-align:center;">25794</td> <td style="text-align:center;">25797.2</td> <td style="text-align:center;">17%</td></tr> <tr><td style="text-align:center;">搭载 ParallelUglifyPlugin 、happyPack 和 dll</td> <td style="text-align:center;">20792</td> <td style="text-align:center;">20963</td> <td style="text-align:center;">20845</td> <td style="text-align:center;">21675</td> <td style="text-align:center;">21023</td> <td style="text-align:center;">21059.6</td> <td style="text-align:center;">22%</td></tr></tbody></table> <p>可见，搭载 dll 后，webpack4 编译速度仍能提升 22%。</p> <p>综上，我们汇总上面的多次数据，得到下表：</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">第 1 次</th> <th style="text-align:center;">第 2 次</th> <th style="text-align:center;">第 3 次</th> <th style="text-align:center;">第 4 次</th> <th style="text-align:center;">第 5 次</th> <th style="text-align:center;">平均</th> <th style="text-align:center;">速度提升</th></tr></thead> <tbody><tr><td style="text-align:center;">webpack3</td> <td style="text-align:center;">58293</td> <td style="text-align:center;">60971</td> <td style="text-align:center;">57263</td> <td style="text-align:center;">58993</td> <td style="text-align:center;">60459</td> <td style="text-align:center;">59195.8</td> <td style="text-align:center;">-</td></tr> <tr><td style="text-align:center;">webpack4</td> <td style="text-align:center;">42346</td> <td style="text-align:center;">40386</td> <td style="text-align:center;">40138</td> <td style="text-align:center;">40330</td> <td style="text-align:center;">40323</td> <td style="text-align:center;">40704.6</td> <td style="text-align:center;">45%</td></tr> <tr><td style="text-align:center;">搭载 ParallelUglifyPlugin 、happyPack 和 dll</td> <td style="text-align:center;">20792</td> <td style="text-align:center;">20963</td> <td style="text-align:center;">20845</td> <td style="text-align:center;">21675</td> <td style="text-align:center;">21023</td> <td style="text-align:center;">21059.6</td> <td style="text-align:center;">181%</td></tr></tbody></table> <p>升级至 webpack4 后，通过搭载 ParallelUglifyPlugin 、happyPack 和 dll 插件，编译速度可以提升 181%，整体编译时间减少了将近 2/3，为开发节省了大量编译时间！而且随着项目发展，这种编译提升越来越可观。</p> <p>实际上，为了获得上面的测试数据，我关闭了 babel、ParallelUglifyPlugin 的缓存，开启缓存后，第二次编译时间平均为 12.8s，由于之前缓存过，编译速度相对 webpack3 将提升 362%，即使你已经升级到 webpack4，搭载上述 3 款插件后，编译速度仍能获得 218% 的提升！</p> <h2 id="编译结果分析"><a href="#编译结果分析" class="header-anchor">#</a> 编译结果分析</h2> <p>当然，编译速度作为一项指标，影响的更多是开发者体验，与之相比，编译后文件大小更为重要。webpack4 编译的文件，比之前版本略小一些，为了更好的追踪文件 size 变化，开发环境和生产环境都需要引入 webpack-bundle-analyzer 插件，如下图。</p> <p><img src="/assets/img/webpack7.4b2f67f9.png" alt="analyzer"></p> <p>文件 size 如下图所示：</p> <p><img src="/assets/img/webpack8.fddce51d.png" alt="analyzer.size"></p> <h2 id="面向-tree-shaking，约束编码"><a href="#面向-tree-shaking，约束编码" class="header-anchor">#</a> 面向 tree-shaking，约束编码</h2> <p><strong>sideEffects</strong></p> <p>从 webpack2 开始，tree-shaking 便用来消除无用模块，依赖的是 ES Module 的静态结构，同时通过在. babelrc 文件中设置 <code>&quot;modules&quot;: false</code> 来开启无用的模块检测，相对粗暴。webapck4 灵活扩展了无用代码检测方式，主要通过在 <code>package.json</code> 文件中设置 <code>sideEffects: false</code> 来告诉编译器该项目或模块是 pure 的，可以进行无用模块删除，因此，开发公共组件时，可以尝试设置下。</p> <p>为了使得 tree-shaking 真正生效，引入资源时，仅仅引入需要的组件尤为重要，如下所示：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'element-ui'</span> <span class="token comment">// 只引入需要的组件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="结尾"><a href="#结尾" class="header-anchor">#</a> 结尾</h2> <p>升级 webpack4 的过程，踩坑是必须的，关键是踩坑后，你能得到什么？</p> <p>另外，除了文中介绍的一些优化方法，更多的优化策略，正在逐步验证中…</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">1/10/2020, 5:47:17 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/request/" class="prev">
        接口请求
      </a></span> <span class="next"><a href="/guide/store/">
        数据容器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ad74b50b.js" defer></script><script src="/assets/js/2.2054c3ab.js" defer></script><script src="/assets/js/3.a4e279d6.js" defer></script>
  </body>
</html>
